#Mounting the QEMU qcow2 image from the host Linux
#run as sudo
apt-get install libguestfs-tools 
cd $ANDROID-QEMU
mkdir img 
guestmount -a disk.img -m /dev/sda1 img/
#Setting up the system.sfs file
cp system.sfs ../..   #copying the system.sfs away 
cd ../..
umount img
mkdir SYS
mv system.sfs SYS
cd SYS
unsquashfs system.sfs #extracting the system.sfs
#Creating a new mount directory
#run without sudo
mkdir img
mount -o loop system.img img 
#Creating a custom certificate via OpenSSL
cd $CERTIFICATE-LOCATION
openssl req -x509 -days 730 -nodes -newkey rsa:2048 -outform der -keyout server.key -out ca.der -extensions v3_ca
openssl rsa -in server.key -inform pem -out server.key.der -outform der
openssl pkcs8 -topk8 -in server.key.der -inform der -out server.key.pkcs8.der -outform der -nocrypt
openssl x509 -inform der -in ca.der -out ca.pem
openssl x509 -inform PEM -subject_hash_old -in ca.pem | head -1
cp ca.pem abcdefg1.0
openssl x509 -inform PEM -text -in ca.pem -out /dev/null>> abcdefg1.0
#Move to the extracted image on Android 
#run as sudo
mv abcdefg1.0 $ANDROID-QEMU/SYS/squashfs-root/img/etc/security/cacerts
#Pack all these things back together
cd $ANDROID-QEMU/SYS/squashfs.root/
umount img 
rm -rf img
cd ..
mkdir BACKUP
mv system.sfs BACKUP/                          
mksquashfs squashfs-root system.sfs -b 131072  
#Mount the qemu2 image again
cd $ANDROID-QEMU/
guestmount -a disk.img -m /dev/sda1 img/
cd img/android-8.1-r2 
rm system.sfs              #remove the original system.sfs
cp ../../SYS/system.sfs .  #copy over the new modified one 
cd ../..
umount img
